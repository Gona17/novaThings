

with clicks as(
select distinct cast(sc.telefono_sms as bigint) as telefono_sms, sc.cantidad_clicks_sms as cant_clicks, sc.fecha_ultimo_click as fecha_ultimo_click, null as rsta_mensaje
from de_qua_2cur.dim_qualia_sms_clicks sc
union 
select sr.tel_1 as telefono_sms, -1 as cant_clicks, '' as fecha_ultimo_click, sr.mensaje as rsta_mensaje
from de_qua_1raw.sms_rptas sr
)
, tabla as(
select distinct
  '1' as id_campania
, sb.id_cliente as id_cliente
, sha(sb.id_cliente) as id_prospecto
, cc.id_persona as id_persona
, collect_set(cast(fp.categoria as string)) as id_categoria
, collect_set(CASE fp.categoria WHEN -1 THEN 'NO INFORMADO' WHEN -2 THEN 'NO APLICA' WHEN -3 THEN 'NO ENCONTRADO EN TRADUCTORA' WHEN 0 THEN 'NO CONSUMO' WHEN  1 THEN  'VIAJES' WHEN  2 THEN  'CONSTRUCCION' WHEN  3 THEN  'SALUD' WHEN  4 THEN  'OCIO' WHEN  5 THEN  'ECOMMERCE' WHEN  6 THEN  'TECNOLOGIA Y COMUNICACIONES' WHEN  7 THEN  'MOVILIDAD' WHEN  8 THEN  'EDUCACION' WHEN  9 THEN  'OFICINA' WHEN  10 THEN  'DEPORTE' WHEN  11 THEN  'VIDA DIARIA' WHEN  12 THEN  'MASCOTAS' WHEN  13 THEN  'LUJO' WHEN  14 THEN  'HOGAR' WHEN  15 THEN  'SEGURIDAD' WHEN  16 THEN  'OTROS' ELSE 'NO TUVO CONSUMOS PASADOS' END) AS descripcion_categoria
, collect_set(cast(fp.cantidad_consumos as string)) as q_consumos
, collect_set(cast(fp.fecha_max_consumo as string)) as ult_transaccion
, sb.n_producto as producto_ofrecido
, sb.tel_1 as contacto
, CASE WHEN dc.cant_clicks >= 1 THEN '1' WHEN dc.cant_clicks = -1 THEN '2' ELSE '0' END AS realizo_click
, CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and trim(cc.fecha_emision_poliza) = ''  and (cast(cc.fecha_vig_desde as bigint) - 20210826) between 0 and 15 and cc.nro_poliza_renovada is NULL THEN 'S' ELSE 'N' END as adquirio_producto
, cc.producto as prod_adquirido
, cc.fecha_vig_desde as fecha_adquirido
, dc.fecha_ultimo_click as fecha_ultimo_click
, dc.rsta_mensaje as mensaje_sms
, sb.fecha_proceso as fecha_proceso
, cc.canal
from de_qua_1raw.sms_base sb
left join clicks dc
on sb.tel_1 = dc.telefono_sms
left join de_qua_2cur.dim_mov_cliente_consolidado cc
on sb.id_cliente = cc.id_cliente_core
left join de_qua_3ref.ft_prospectos fp
on sha(sb.id_cliente) = fp.id_prospecto
group by sb.id_cliente,cc.id_persona,sb.n_producto,sb.tel_1,dc.cant_clicks,cc.fecha_vig_desde,cc.fecha_vig_hasta,cc.fecha_emision_poliza,cc.nro_poliza_renovada,cc.producto,dc.fecha_ultimo_click,dc.rsta_mensaje,sb.fecha_proceso,cc.canal
)

select distinct
 tt.id_prospecto
,CASE WHEN tt.id_persona IS NULL THEN tt.id_cliente ELSE tt.id_persona end
,tt.id_campania as id_campania_sms
,null as id_campania_cc
, concat_ws(',',tt.id_categoria) as id_categoria
, concat_ws(',',tt.descripcion_categoria) as descripcion_categoria
, concat_ws(',',tt.q_consumos) as q_consumos
, concat_ws(',',tt.ult_transaccion) as ult_transaccion
, concat_ws(',',tt.producto_ofrecido) as producto_ofrecido
, 'SMS' as canal
, tt.realizo_click as resultado_campania
, '20210826' as fecha_resultado--CASE WHEN tt.realizo_click = '1' THEN tt.fecha_ultimo_click ELSE NULL END as fecha_resultado
, tt.mensaje_sms as mensaje_resultado
, tt.adquirio_producto
, concat_ws(',',collect_set(CASE WHEN tt.adquirio_producto = 'S' THEN tt.prod_adquirido ELSE NULL END)) as producto_adquirido
, concat_ws(',',collect_set(CASE WHEN tt.adquirio_producto = 'S' THEN tt.fecha_adquirido ELSE NULL END)) as fecha_adquisicion
, CASE WHEN tt.adquirio_producto = 'S' THEN tt.canal ELSE NULL END as canal_venta
, '20210826' as fecha_proceso
from tabla tt
group by tt.id_prospecto,tt.id_persona,tt.id_cliente,tt.id_campania,tt.id_categoria,tt.descripcion_categoria,tt.q_consumos
,tt.ult_transaccion,tt.producto_ofrecido,tt.realizo_click,tt.mensaje_sms,tt.adquirio_producto,tt.canal 
;



--PARA SMS VIEJOS, ULTIMA VERSION INSERTADA:

with clicks as(
select distinct cast(sc.telefono_sms as bigint) as telefono_sms, sc.cantidad_clicks_sms as cant_clicks, sc.fecha_ultimo_click as fecha_ultimo_click, null as rsta_mensaje
from de_qua_2cur.dim_qualia_sms_clicks sc
union 
select sr.tel_1 as telefono_sms, -1 as cant_clicks, '' as fecha_ultimo_click, sr.mensaje as rsta_mensaje
from de_qua_1raw.sms_rptas sr
)
, tabla as(
select distinct
  '1' as id_campania
, sb.id_cliente as id_cliente
, sha(sb.id_cliente) as id_prospecto
, cc.id_persona as id_persona
, fp.categoria as id_categoria
, CASE fp.categoria WHEN -1 THEN 'NO INFORMADO' WHEN -2 THEN 'NO APLICA' WHEN -3 THEN 'NO ENCONTRADO EN TRADUCTORA' WHEN 0 THEN 'NO CONSUMO' WHEN  1 THEN  'VIAJES' WHEN  2 THEN  'CONSTRUCCION' WHEN  3 THEN  'SALUD' WHEN  4 THEN  'OCIO' WHEN  5 THEN  'ECOMMERCE' WHEN  6 THEN  'TECNOLOGIA Y COMUNICACIONES' WHEN  7 THEN  'MOVILIDAD' WHEN  8 THEN  'EDUCACION' WHEN  9 THEN  'OFICINA' WHEN  10 THEN  'DEPORTE' WHEN  11 THEN  'VIDA DIARIA' WHEN  12 THEN  'MASCOTAS' WHEN  13 THEN  'LUJO' WHEN  14 THEN  'HOGAR' WHEN  15 THEN  'SEGURIDAD' WHEN  16 THEN  'OTROS' ELSE 'NO TUVO CONSUMOS PASADOS' END AS descripcion_categoria
, CASE WHEN fp.cantidad_consumos IS NOT NULL THEN fp.cantidad_consumos ELSE 0 END as q_consumos
, fp.fecha_max_consumo as ult_transaccion
, sb.n_producto as producto_ofrecido
, sb.tel_1 as contacto
, CASE WHEN dc.cant_clicks >= 1 THEN '1' WHEN dc.cant_clicks = -1 THEN '2' ELSE '0' END AS realizo_click
, CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and cc.fecha_vig_hasta != '' and cc.fecha_vig_desde >= dc.fecha_ultimo_click and cc.nro_poliza_renovada is NULL THEN 'S' ELSE 'N' END as adquirio_producto
, cc.producto as prod_adquirido
, cc.fecha_vig_desde as fecha_adquirido
, dc.fecha_ultimo_click as fecha_ultimo_click
, dc.rsta_mensaje as mensaje_sms
, sb.fecha_proceso as fecha_proceso
from de_qua_1raw.sms_base sb
left join clicks dc
on sb.tel_1 = dc.telefono_sms
left join de_qua_2cur.dim_mov_cliente_consolidado cc
on sb.id_cliente = cc.id_cliente_core
left join de_qua_3ref.ft_prospectos fp
on sha(sb.id_cliente) = fp.id_prospecto
)
insert into de_qua_3ref.ft_resultado_audiencias partition(fecha_proceso)
select distinct
 tt.id_prospecto
,CASE WHEN tt.id_persona IS NULL THEN tt.id_cliente ELSE tt.id_persona end
,tt.id_campania as id_campania_sms
,null as id_campania_cc
, tt.id_categoria
, tt.descripcion_categoria
, tt.q_consumos
, max(tt.ult_transaccion)
, tt.producto_ofrecido
, 'SMS' as canal
, tt.realizo_click as resultado_campania
, '20210826' as fecha_resultado--CASE WHEN tt.realizo_click = '1' THEN tt.fecha_ultimo_click ELSE NULL END as fecha_resultado
, tt.mensaje_sms as mensaje_resultado
, tt.adquirio_producto
, CASE WHEN tt.adquirio_producto = 'S' THEN tt.prod_adquirido ELSE NULL END as producto_adquirido
, CASE WHEN tt.adquirio_producto = 'S' THEN tt.fecha_adquirido ELSE NULL END as fecha_adquisicion
, tt.fecha_proceso
from tabla tt
group by tt.id_prospecto,tt.id_persona,tt.id_cliente,tt.id_campania,tt.id_categoria,tt.descripcion_categoria,tt.q_consumos,tt.producto_ofrecido,tt.realizo_click,tt.fecha_ultimo_click,tt.mensaje_sms,tt.adquirio_producto,tt.prod_adquirido,tt.fecha_adquirido,tt.fecha_proceso;





---- PARA LA TABLA DE AUDIENCIAS SMS:


with clicks as(
select distinct cast(sc.telefono_sms as bigint) as telefono_sms, sc.cantidad_clicks_sms as cant_clicks, sc.fecha_ultimo_click as fecha_ultimo_click, null as rsta_mensaje
from de_qua_2cur.dim_qualia_sms_clicks sc
union 
select sr.tel_1 as telefono_sms, -1 as cant_clicks, '' as fecha_ultimo_click, sr.mensaje as rsta_mensaje
from de_qua_1raw.sms_rptas sr
)
, tabla as(
select 
count(distinct ap.fecha_proceso)+1 as id_campania
, ap.id_prospecto as id_prospecto
, ap.id_persona as id_persona
, collect_set(cast(fp.categoria as string)) as id_categoria
, collect_set(CASE fp.categoria WHEN -1 THEN 'NO INFORMADO' WHEN -2 THEN 'NO APLICA' WHEN -3 THEN 'NO ENCONTRADO EN TRADUCTORA' WHEN 0 THEN 'NO CONSUMO' WHEN  1 THEN  'VIAJES' WHEN  2 THEN  'CONSTRUCCION' WHEN  3 THEN  'SALUD' WHEN  4 THEN  'OCIO' WHEN  5 THEN  'ECOMMERCE' WHEN  6 THEN  'TECNOLOGIA Y COMUNICACIONES' WHEN  7 THEN  'MOVILIDAD' WHEN  8 THEN  'EDUCACION' WHEN  9 THEN  'OFICINA' WHEN  10 THEN  'DEPORTE' WHEN  11 THEN  'VIDA DIARIA' WHEN  12 THEN  'MASCOTAS' WHEN  13 THEN  'LUJO' WHEN  14 THEN  'HOGAR' WHEN  15 THEN  'SEGURIDAD' WHEN  16 THEN  'OTROS' ELSE 'NO TUVO CONSUMOS PASADOS' END) AS descripcion_categoria
, collect_set(cast(fp.cantidad_consumos as string)) as q_consumos
, collect_set(cast(fp.fecha_max_consumo as string)) as ult_transaccion
,ap.producto as producto_ofrecido
,ap.Nro_cel as contacto
,CASE WHEN dc.cant_clicks >= 1 THEN '1' WHEN dc.cant_clicks = -1 THEN '2' ELSE '0' END AS realizo_click
,CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and trim(cc.fecha_emision_poliza) = ''  and (cast(cc.fecha_vig_desde as bigint) - cast(dc.fecha_ultimo_click as bigint)) between 0 and 15 and cc.nro_poliza_renovada is NULL THEN 'S' ELSE 'N' END as adquirio_producto
,cc.producto as prod_adquirido
,cc.fecha_vig_desde as fecha_adquirido
,dc.fecha_ultimo_click as fecha_ultimo_click
,dc.rsta_mensaje as mensaje_resultado
,cc.canal as canal_venta
,ap.fecha_proceso as fecha_proceso
from de_qua_3ref.ft_audiencia_sms ap
left join clicks dc
on ap.Nro_cel = dc.telefono_sms
left join de_qua_2cur.dim_mov_cliente_consolidado cc
on ap.id_persona = cc.id_persona
left join de_qua_3ref.ft_prospectos fp
on ap.id_prospecto = fp.id_prospecto 
group by ap.id_prospecto, ap.id_persona,ap.producto,ap.tipo_contacto,ap.Nro_cel,dc.cant_clicks,cc.producto,cc.fecha_vig_desde,cc.fecha_vig_hasta,cc.fecha_emision_poliza,cc.nro_poliza_renovada,dc.fecha_ultimo_click,dc.rsta_mensaje,cc.canal,ap.fecha_proceso
)
select distinct
 tt.id_prospecto
, tt.id_persona
, tt.id_campania as id_campania_sms
, null as id_campania_cc
, concat_ws(',',tt.id_categoria) as id_categoria
, concat_ws(',',tt.descripcion_categoria) as descripcion_categoria
, concat_ws(',',tt.q_consumos) as q_consumos
, concat_ws(',',tt.ult_transaccion) as ult_transaccion
, concat_ws(',',tt.producto_ofrecido) as producto_ofrecido
, 'SMS' as canal
, tt.realizo_click as resultado_campania
, tt.fecha_proceso as fecha_resultado
, tt.mensaje_resultado
, tt.adquirio_producto
, concat_ws(',',collect_set(CASE WHEN tt.adquirio_producto = 'S' THEN tt.prod_adquirido ELSE NULL END)) as producto_adquirido
, concat_ws(',',collect_set(CASE WHEN tt.adquirio_producto = 'S' THEN tt.fecha_adquirido ELSE NULL END)) as fecha_adquisicion
, CASE WHEN tt.adquirio_producto = 'S' THEN tt.canal_venta ELSE NULL END as canal_venta
from tabla tt
group by  tt.id_prospecto
, tt.id_persona
, tt.id_campania
, tt.id_categoria
, tt.descripcion_categoria
, tt.q_consumos
, tt.ult_transaccion
, tt.producto_ofrecido
, tt.canal
, tt.realizo_click
, tt.fecha_proceso
, tt.mensaje_resultado
, tt.adquirio_producto
, tt.canal
;






----PARA CALLCENTER:


with tabla as (
select distinct
sha(cr.id_cliente_core) as id_prospecto
, cast(cr.id_persona as bigint) as id_persona
, null as id_campania_sms
, cast(cr.campaniaid as int) as id_campania_cc
, fp.categoria as id_categoria
, CASE fp.categoria WHEN 0 THEN 'NO CONSUMO' WHEN  1 THEN  'VIAJES' WHEN  2 THEN  'CONSTRUCCION' WHEN  3 THEN  'SALUD' WHEN  4 THEN  'OCIO' WHEN  5 THEN  'ECOMMERCE' WHEN  6 THEN  'TECNOLOGIA Y COMUNICACIONES' WHEN  7 THEN  'MOVILIDAD' WHEN  8 THEN  'EDUCACION' WHEN  9 THEN  'OFICINA' WHEN  10 THEN  'DEPORTE' WHEN  11 THEN  'VIDA DIARIA' WHEN  12 THEN  'MASCOTAS' WHEN  13 THEN  'LUJO' WHEN  14 THEN  'HOGAR' WHEN  15 THEN  'SEGURIDAD' WHEN  16 THEN  'OTROS' ELSE 'NO APLICA' END AS descripcion_categoria
, fp.cantidad_consumos as q_consumos--CASE WHEN tc.cantidad_consumos IS NOT NULL THEN max(tc.cantidad_consumos) ELSE 0 END as q_consumos
, fp.fecha_max_consumo as ult_transaccion
, cr.combinacionproductos as producto_ofrecido
, 'callcenter' as canal
, CASE WHEN cr.gruporesultadoid in (4,7,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28) THEN '1' WHEN cr.gruporesultadoid in (6,8,9,10) THEN '2' ELSE '0' END as resultado_campania 
, cr.fechainicio as fecha_resultado
, cr.descripcion as mensaje_resultado
, CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and cc.fecha_vig_hasta != '' and cc.fecha_vig_desde >= cr.fechainicio and cc.nro_poliza_renovada is NULL THEN 'S' ELSE 'N' END as adq_prod
, CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and cc.fecha_vig_hasta != '' and cc.fecha_vig_desde >= cr.fechainicio and cc.nro_poliza_renovada is NULL THEN cc.producto ELSE NULL END as prod_ad
, CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and cc.fecha_vig_hasta != '' and cc.fecha_vig_desde >= cr.fechainicio and cc.nro_poliza_renovada is NULL THEN cc.fecha_vig_desde ELSE NULL END AS fech_ad
from de_qua_2cur.dim_cc_resultado cr
left join de_qua_3ref.ft_prospectos fp
on sha(cr.id_cliente_core) = fp.id_prospecto
left join de_qua_2cur.dim_mov_cliente_consolidado cc
on cr.id_cliente_core = cc.id_cliente_core
)
select distinct id_prospecto,id_persona,id_campania_sms,id_campania_cc,COLLECT_set(id_categoria) as id_categoria,COLLECT_set(descripcion_categoria) as descripcion_categoria,COLLECT_set(q_consumos) as q_consumos,COLLECT_set(ult_transaccion) as ult_transaccion,COLLECT_set(producto_ofrecido) as producto_ofrecido,canal,resultado_campania,fecha_resultado,mensaje_resultado,case when adq_prod = 'S' and resultado_campania != '1' THEN 'N' WHEN adq_prod = 'S' and resultado_campania = '1' THEN 'S' else 'N' end as adquirio_producto,case when adq_prod = 'S' and resultado_campania != '1' THEN NULL WHEN adq_prod = 'S' and resultado_campania = '1' THEN prod_ad else NULL end as producto_adquirido,CASE WHEN adq_prod = 'S' and resultado_campania != '1' THEN NULL WHEN adq_prod = 'S' and resultado_campania = '1' THEN fech_ad else null end as fecha_adquisicion 
from tabla
group by id_prospecto,id_persona,id_campania_sms,id_campania_cc,canal,resultado_campania,fecha_resultado,mensaje_resultado,adq_prod,prod_ad,fech_ad
order by id_persona desc limit 1000;



--nueva

with callcenter as(
SELECT DISTINCT sha(cr.id_cliente_core) AS id_prospecto,
                cr.id_cliente_core AS id_cliente_core,
                cast(cr.id_persona AS bigint) AS id_persona,
                cast(cr.campaniaid AS int) AS id_campania_cc,
                cr.combinacionproductos AS producto_ofrecido,
                CASE
                    WHEN cr.gruporesultadoid IN (4,7,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28) THEN '1'
                    WHEN cr.gruporesultadoid IN (6,8,9,10) THEN '2'
                    ELSE '0'
                END AS resultado_campania,
                cr.fechainicio AS fecha_resultado,
                cr.descripcion AS mensaje_resultado
FROM de_qua_2cur.dim_cc_resultado cr
)
,propectos as(
SELECT DISTINCT fp.id_prospecto ,
                cast(fp.categoria as string) AS id_categoria ,
                CASE fp.categoria
                    WHEN 0 THEN 'NO CONSUMO'
                    WHEN 1 THEN 'VIAJES'
                    WHEN 2 THEN 'CONSTRUCCION'
                    WHEN 3 THEN 'SALUD'
                    WHEN 4 THEN 'OCIO'
                    WHEN 5 THEN 'ECOMMERCE'
                    WHEN 6 THEN 'TECNOLOGIA Y COMUNICACIONES'
                    WHEN 7 THEN 'MOVILIDAD'
                    WHEN 8 THEN 'EDUCACION'
                    WHEN 9 THEN 'OFICINA'
                    WHEN 10 THEN 'DEPORTE'
                    WHEN 11 THEN 'VIDA DIARIA'
                    WHEN 12 THEN 'MASCOTAS'
                    WHEN 13 THEN 'LUJO'
                    WHEN 14 THEN 'HOGAR'
                    WHEN 15 THEN 'SEGURIDAD'
                    WHEN 16 THEN 'OTROS'
                    ELSE 'NO APLICA'
                END AS descripcion_categoria ,
                cast(fp.cantidad_consumos as string) AS q_consumos
                , cast(fp.fecha_max_consumo as string) AS ult_transaccion
FROM de_qua_3ref.ft_prospectos fp
)
,clientesQua as(
SELECT DISTINCT cc.id_cliente_core,
                cc.id_persona,
                cc.producto,
                cc.fecha_vig_desde,
                cc.fecha_vig_hasta,
                cc.fecha_emision_poliza,
                cc.nro_poliza_renovada,
		cc.canal
FROM de_qua_2cur.dim_mov_cliente_consolidado cc
)
,callprospectos as (
SELECT DISTINCT call.id_cliente_core,
                CALL.id_prospecto,
                call.id_persona,
                call.id_campania_cc,
                collect_set(call.producto_ofrecido) as producto_ofrecido,
                call.resultado_campania,
                call.fecha_resultado,
                call.mensaje_resultado,
                collect_set(pr.id_categoria) as id_categoria,
                collect_set(pr.descripcion_categoria) as descripcion_categoria,
                collect_set(pr.q_consumos) as q_consumos,
                collect_set(pr.ult_transaccion) as ult_transaccion
FROM callcenter CALL
LEFT JOIN propectos pr 
ON call.id_prospecto = pr.id_prospecto
group by call.id_cliente_core,
                call.id_prospecto,
                call.id_persona,
                call.id_campania_cc,
                call.resultado_campania,
                call.fecha_resultado,
                call.mensaje_resultado
)
,tabla as (
SELECT distinct 
                cp.id_prospecto,
                cp.id_persona,
                NULL AS id_campania_sms,
                cp.id_campania_cc,
                cp.id_categoria,
                cp.descripcion_categoria,
                cp.q_consumos,
                cp.ult_transaccion,
                cp.producto_ofrecido,
                'callcenter' as canal,
                cp.resultado_campania,
                cp.fecha_resultado,
                cp.mensaje_resultado,
                collect_set(CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and trim(cc.fecha_emision_poliza) = ''  and (cast(cc.fecha_vig_desde as bigint) - cast(cp.fecha_resultado as bigint)) between 0 and 15 and cc.nro_poliza_renovada is NULL and cp.resultado_campania = '1' THEN 'S' ELSE 'N' END) as adquirio_producto,
                collect_set(CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and trim(cc.fecha_emision_poliza) = ''  and (cast(cc.fecha_vig_desde as bigint) - cast(cp.fecha_resultado as bigint)) between 0 and 15 and cc.nro_poliza_renovada is NULL and cp.resultado_campania = '1' THEN cc.producto ELSE NULL END) as producto_adquirido,
                collect_set(CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and trim(cc.fecha_emision_poliza) = ''  and (cast(cc.fecha_vig_desde as bigint) - cast(cp.fecha_resultado as bigint)) between 0 and 15 and cc.nro_poliza_renovada is NULL and cp.resultado_campania = '1' THEN cc.fecha_vig_desde ELSE NULL END) as fecha_adquisicion
		        ,CASE WHEN cc.fecha_vig_desde != cc.fecha_vig_hasta and trim(cc.fecha_emision_poliza) = ''  and (cast(cc.fecha_vig_desde as bigint) - cast(cp.fecha_resultado as bigint)) between 0 and 15 and cc.nro_poliza_renovada is NULL and cp.resultado_campania = '1' THEN cc.canal ELSE NULL end as canal_venta
FROM callprospectos cp
LEFT JOIN clientesQua cc 
ON cp.id_cliente_core = cc.id_cliente_core
GROUP BY        cp.id_prospecto,
                cp.id_persona,
                cp.id_campania_cc,
                cp.id_categoria,
                cp.descripcion_categoria,
                cp.q_consumos,
                cp.ult_transaccion,
                cp.producto_ofrecido,
                cp.resultado_campania,
                cp.fecha_resultado,
                cp.mensaje_resultado,
                cc.fecha_vig_desde,cc.fecha_vig_hasta,cc.fecha_emision_poliza,cc.nro_poliza_renovada,
		        cc.canal
)
select distinct 
                id_prospecto,
                id_persona,
                id_campania_sms,
                id_campania_cc,
                concat_ws(',',id_categoria) as id_categoria,
                concat_ws(',',descripcion_categoria) as descripcion_categoria,
                concat_ws(',',q_consumos) as q_consumos,
                concat_ws(',',ult_transaccion) as ult_transaccion,
                concat_ws(',',producto_ofrecido) as producto_ofrecido,
                canal,
                resultado_campania,
                fecha_resultado,
                mensaje_resultado,
                CASE WHEN array_contains(adquirio_producto,'S') THEN 'S' ELSE 'N' END AS adquirio_producto,
                concat_ws(',',producto_adquirido) as producto_adquirido,
                concat_ws(',',fecha_adquisicion) as fecha_adquisicion,
		        canal_venta,
		        '20210701' as fecha_proceso
from tabla
;
