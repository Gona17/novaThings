with cierres as (select distinct id_persona, cast(CONCAT(TRIM(cuenta), TRIM(digito)) as bigint) as cuenta from de_${entidad}_1raw.cierre_mensual_visa_mc where id_persona is not null and id_persona not in ('0', '-99')) SELECT DISTINCT NULL as id_persona, CAST(rc.Id_Cliente_Core AS BIGINT) as id_cliente_core, CAST(cm.nro_lote AS STRING) as nro_lote, CAST(cm.nro_boleta AS BIGINT) as nro_boleta, CAST(cm.cod_transac AS INT) as id_transaccion, CAST(cm.nro_bco_suc_mov AS INT) as id_banco_sucursal_mov, CAST(cm.reservado_uso_casa1 AS INT) as filler_credencial_1, CAST(cm.nro_cupon AS INT) as nro_cupon, CAST(cm.cod_mon AS INT) as id_moneda, CAST(concat(substr(cm.imp_cotiz,1,5),'.',substr(cm.imp_cotiz,-4)) AS DECIMAL(9,4)) as valor_cotiz_conversion, CAST( concat( substr( concat( substr(cm.imp_tot_vta, 1, 12), CASE substr(cm.imp_tot_vta, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_tot_vta, -1) END ), 1, 11 ), '.', substr( concat( substr(cm.imp_tot_vta, 1, 12), CASE substr(cm.imp_tot_vta, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_tot_vta, -1) END ), -2 ) ) AS DECIMAL(13, 2) ) as mto_total_en_cuotas, CAST( concat( substr( concat( substr(cm.imp_tot_orig, 1, 12), CASE substr(cm.imp_tot_orig, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_tot_orig, -1) END ), 1, 11 ), '.', substr( concat( substr(cm.imp_tot_orig, 1, 12), CASE substr(cm.imp_tot_orig, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_tot_orig, -1) END ), -2 ) ) AS DECIMAL(13, 2) ) as mto_total, CAST( concat( substr( concat( substr(cm.imp_sdes, 1, 12), CASE substr(cm.imp_sdes, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_sdes, -1) END ), 1, 11 ), '.', substr( concat( substr(cm.imp_sdes, 1, 12), CASE substr(cm.imp_sdes, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_sdes, -1) END ), -2 ) ) AS DECIMAL(13, 2) ) as mto_total_sin_descuento, CAST( concat( substr( concat( substr(cm.imp_tot, 1, 12), CASE substr(cm.imp_tot, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_tot, -1) END ), 1, 11 ), '.', substr( concat( substr(cm.imp_tot, 1, 12), CASE substr(cm.imp_tot, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_tot, -1)END),-2)) AS DECIMAL(13, 2)) as mto_total_2, cm.forigen as fecha_origen_mov, cm.fepres as fecha_presentaccion_mov, cm.feproc as fecha_proceso_mov, cm.fclear as fecha_clearing_mov, cm.fliqcom as fecha_liq_mov_comercios, cm.fliqusu as fecha_liq_socios, cm.fpago as fecha_pago_mov, cm.fvenc as fecha_vto_mov, CAST(cm.nro_com AS STRING) as id_comercio, CAST(cm.plazo AS INT) as plazo_pago, CAST(concat(substr(cm.por_descto,1,2),'.',substr(cm.por_descto,-2)) AS DECIMAL(4,2)) as porc_retencion_comercio, CAST(cm.cod_rubro AS INT) as id_rubro_mov, CAST( concat( substr( concat( substr(por_alicuota_iva_com, 1, 4), CASE substr(por_alicuota_iva_com, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(por_alicuota_iva_com, -1) END ), 1, 3 ), '.', substr( concat( substr(por_alicuota_iva_com, 1, 4), CASE substr(por_alicuota_iva_com, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(por_alicuota_iva_com, -1)END),-2)) AS DECIMAL(5, 2)) as porc_iva,CAST(cm.cod_producto_com AS INT) as id_producto_vta_comercio,CAST(concat((concat(substr(cm.imp_fijo_asoc_vta, 1, 12),CASE substr(cm.imp_fijo_asoc_vta, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5'WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_fijo_asoc_vta, -1)END),1,11),'.',substr(concat(substr(cm.imp_fijo_asoc_vta, 1, 12),CASE substr(cm.imp_fijo_asoc_vta, -1) WHEN 'p' THEN '0' WHEN 'q' THEN '1' WHEN 'r' THEN '2' WHEN 's' THEN '3' WHEN 't' THEN '4' WHEN 'u' THEN '5' WHEN 'v' THEN '6' WHEN 'w' THEN '7' WHEN 'x' THEN '8' WHEN 'y' THEN '9' ELSE substr(cm.imp_fijo_asoc_vta, -1)END),-2)) AS DECIMAL(13, 2)) as mto_prestamo,CAST(cm.nro_bco_suc_ruc AS STRING) as id_banco_sucursal_cliente,CAST(cm.nro_ruc AS STRING) as nro_cuenta,CAST(cm.nro_tar AS STRING) as nro_tarjeta,CAST(cm.grupo AS INT) as id_grupo_liq,CAST(concat(substr(cm.imp_iva_usu,1,11),'.',substr(cm.imp_iva_usu,-2)) AS DECIMAL(13,2)) as mto_retencion_iva,CAST(cm.cod_producto_cta AS STRING) as id_producto_cta,CAST(cm.nro_aut AS BIGINT) as nro_autorizacion_mov,cm.mon_orig as id_moneda_original,cm.fpago_mc as fecha_pago_credencial,CAST(cm.cod_tasint_mc AS INT) as id_tasa_int_credencial,CAST(cm.cod_financ AS INT) as id_financiacion,CAST(cm.filler AS STRING) as filler_credencial_2,CAST(cm.cod_zogeo_orig AS STRING) as id_zona_geo_origen,CAST(cm.cod_zogeo_dest AS STRING) as id_zona_geo_destino,CAST(cm.cod_debaut AS INT) as id_debito_automatico,CAST(cm.tip_vta AS STRING) as tipo_venta,CAST(cm.mont_contrap AS INT) as id_mot_contrapartida,cm.forigen_posnet as fecha_origen_mov_posnet,CAST(cm.cuota AS INT) as nro_cuota,CAST(cm.mar_financiable AS STRING) as marca_mov_financiero,CAST(cm.mar_exc_lim_cpra AS STRING) as marca_mov_lim_compra,CAST(cm.mar_ret_iva AS STRING) as marca_retencion_iva,CAST(cm.mar_cuo_anti AS STRING) asmarca_mov_cuota_ant,CAST(concat(substr(cm.por_tas_int_pag_ade,1,3),'.',substr(cm.por_tas_int_pag_ade,-3)) AS DECIMAL(6,3)) as porc_tasa_int_pagadora,CAST(concat(substr(cm.imp_int_pag_ade,1,11),'.',substr(cm.imp_int_pag_ade,-2)) AS DECIMAL(13,2)) as mto_interes_adelantado,CAST(concat(substr(cm.por_tas_int_emi_ade,1,3),'.',substr(cm.por_tas_int_emi_ade,-3)) AS DECIMAL(6,3)) as porc_tasa_int_adelantado,CAST(concat(substr(cm.por_ara_ade,1,3),'.',substr(cm.por_ara_ade,-3)) AS DECIMAL(6,3)) as mto_adelanto,CAST(concat(substr(cm.por_tas_sel_ade,1,3),'.',substr(cm.por_tas_sel_ade,-3)) AS DECIMAL(6,3)) as porc_tasa_sellado_adelanto,CAST(cm.den_mov AS STRING) as desc_mov,CAST(cm.den_mov_adi AS STRING) as desc_adicional_mov,CAST(cm.est_proc AS STRING) as id_estado_proceso,CAST(cm.reservado_uso_casa3 AS STRING) as filler_credencial_3,CAST(cm.can_cuotas_plan AS INT) as q_cuotas_plan,CAST(cm.reservado_uso_casa4 AS STRING) as filler_credencial_4,CAST(concat(substr(cm.tasa_intercam,1,11),'.',substr(cm.tasa_intercam,-2)) AS DECIMAL(13,2)) mto_tasa_intercambio,CAST(cm.ref_univ_de31 AS STRING) as id_referencia_mc,CAST(cm.com_mc AS STRING) as id_comercio_mc,CAST(cm.de22 AS STRING) as id_modo_ingreso_mc,CAST(cm.filler1 AS STRING) as filler_3,CAST(cm.tip_reg AS STRING) as fuente_registro from de_${entidad}_1raw.cred_movimientos cm inner join cierres on CAST(cm.nro_ruc AS BIGINT) = cierres.cuenta inner join de_${entidad}_2cur.rel_cliente_core_documentos rc on cierres.id_persona = rc.id_persona