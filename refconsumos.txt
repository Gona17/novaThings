WITH clientes AS (SELECT DISTINCT id_cliente_core FROM de_${entidad}_2cur.cliente_homologado_ext), rank_table_cred AS (SELECT DISTINCT mto_total mt, ROUND(PERCENT_RANK() OVER (ORDER BY ROUND(NVL(mto_total,0),1)) * 100,0) AS rank FROM de_${entidad}_2cur.ft_ttcc_movimientos_credencial WHERE nro_cuota < 2 AND NVL(id_rubro_mov,0) != 0), rank_table_pris AS (SELECT DISTINCT mto_orig mt, ROUND(PERCENT_RANK() OVER (ORDER BY ROUND(NVL(mto_orig,0),1)) * 100,0) AS rank FROM de_${entidad}_2cur.ft_ttcc_movimientos_prisma WHERE nro_cuota < 2 AND NVL(id_rubro_movimiento,0) != 0) SELECT rc.Id_Cliente_Core, ft.Id_Transaccion, ft.fecha_origen_mov AS fecha_transaccion, CAST(ft.mto_total AS decimal(13,2)) AS mto_transaccion, CAST(ft.id_moneda AS STRING), 'MC' AS id_tarjetera, ft.id_rubro_mov AS id_rubro, CAST(pb.id_param AS INT) AS id_categoria FROM clientes rc INNER JOIN de_${entidad}_2cur.ft_ttcc_movimientos_credencial ft ON rc.id_cliente_core = CAST(ft.id_cliente_core AS BIGINT) INNER JOIN de_gpn_1raw.param_bco_tarjetas_rubro_relacion pb ON ft.id_rubro_mov = CAST(pb.codigo_origen AS INT) WHERE ft.nro_cuota < 2 AND NVL(ft.id_rubro_mov,0) != 0 AND ft.mto_total BETWEEN (SELECT MAX(a.mt) FROM rank_table_cred a WHERE a.rank = 10) AND (SELECT MIN(a.mt) FROM rank_table_cred a WHERE a.rank = 90) UNION ALL SELECT rc.Id_Cliente_Core, ft.Id_Transaccion, ft.fecha_origen_movimiento, CAST(ft.mto_orig AS decimal(13,2)), ft.id_moneda_transaccion, 'VI' AS id_tarjetera, ft.id_rubro_movimiento, CAST(pb.id_param AS INT) FROM clientes rc INNER JOIN de_${entidad}_2cur.ft_ttcc_movimientos_prisma ft ON rc.id_cliente_core = CAST(ft.id_cliente_core AS BIGINT) INNER JOIN de_gpn_1raw.param_bco_tarjetas_rubro_relacion pb ON ft.id_rubro_movimiento = CAST(pb.codigo_origen AS INT) WHERE ft.nro_cuota < 2 AND NVL(ft.id_rubro_movimiento,0) != 0 AND ft.mto_orig BETWEEN (SELECT MAX(a.mt) FROM rank_table_pris a WHERE a.rank = 10) AND (SELECT MIN(a.mt) FROM rank_table_pris a WHERE a.rank = 90)